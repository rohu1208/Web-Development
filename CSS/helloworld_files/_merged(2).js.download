function posts(t){this.options={filter:null,context:null,enableNewPost:!0,enableNotifications:!0,enableNewComment:!0,enableActions:!0,commentsNumCollapse:5,enableSystemPosts:!1,doNotLoadonInit:!1,loadReadyCallback:null,loadReadyCallbackOnce:!0,afterPostRenderCallback:!1},$.extend(this.options,t),this.latestFilter=this.options.filter,this.context={load:null,save:null},this.options.context&&this.setContext(this.options.context.load,this.options.context.save,!0),this.$els={container:$("#postsContainer"),posts:$("#postsFeed"),noPostsFound:$("#initialPost").parent(),postsMsg:$("#postsNotifications"),listPeopleHover:$("#listPeopleHover"),postForm:$("#postForm"),postRenderer:$("#postItemTemplate"),sysPostRenderer_news:$("#system_newsTemplate"),sysPostRenderer_articles:$("#system_articlesTemplate"),sysPostRenderer_users:$("#system_usersTemplate"),sysPostRenderer_badges:$("#system_badgesTemplate"),sysPostRenderer_popular:$("#system_popularTemplate"),commentRenderer:$("#commentItemTemplate")},this.templateFormElements={postAddButton:"#postForm .-share-button",postForm:"#postForm",addImage:"#addImage",addTip:"#addTip",addLC:"#addCode",addPoll:"#addPoll",addLink:"#addLink",wait:"#waitingWrapper",postFormPollAddChoice:"#addPoll .add-choice"},this.$emptyFormElements={},this.formPointers={postFormTabs:"#postFormChoices .share-choice-wrapper",postFormObjects:"#post_form_objects .object_form",postFormPollChoices:"#addPoll .poll-choice"},this.$formCollections={},this.groupClass={postItem:".post-wrapper",sysPost:"system-card",commentItem:".comment",comments:".comments-wrapper",commentsView:".view-all-comm a",commentForm:".make-comment",commentButton:".comment-but",commentShare:".js-comment-share",pollOption:".poll-choice",pollDescription:".-poll-desc",pollVote:".poll-to-vote",pollFlow:".poll-in-flow",pollWaiting:".-waiting-spinner",postText:".post-text",post_likes:".post-star",post_best_of:".post-badge",commentText:".comment-text",comment_likes:".comm-star",comment_best_of:".comm-badge",post_comments_num:".post-caption .comments_num",post_best_of_num:".post-caption .best_of_num",post_likes_num:".post-caption .likes-num",comment_best_of_num:".best_of_num",comment_likes_num:".likes-num",postControls:".post-caption .controls",commentControls:".controls",postUpdate:".post-update",postDelete:".post-delete",commentUpdate:".comment-update",commentDelete:".comment-delete",postTimeAgo:".post-date",postTimeAgoM:".last-update",postDateShort:".date-timeline",commentTimeAgo:".comment-time"},this.selClass={newPost:"new",commentMore:"comment_more",commentsOpen:"comments_open",best_of:"best_of",likes:"like",data:"data",listPeopleNames:"member-list-name",team:"share-team"},this.allPostsData={},this.sysPostData=[],this.sysPostIndex=0,this.newPost={text:"",text_mentions:[],context:null,social_object:{type:null,data:null},comments:[],likes:null,best_of:null,counters:{likes:!1,bestOf:!1,comments:!1},me:{likes:!1,bestOf:!1,comments:!1},has_controls:!0},this.newComment={text:"",text_mentions:[],likes:null,best_of:null,counters:{likes:!1,bestOf:!1},me:{likes:!1,bestOf:!1},has_controls:!0},this.latestPost=null,this.latestComment=null,this.lastDateShort="",this.firstKey=null,this.lastKey=null,this.latestKey=null,this.codetipobj=null,this.codelcobj=null,this.timers={newPost:null},this.timeFetchNew="undefined"!=typeof SOCIAL_FETCH_NEW&&SOCIAL_FETCH_NEW?SOCIAL_FETCH_NEW:6e4,this.timeForDelete=18e4,this.timeFade=300,this.mentionsOptions={onDataRequest:this.queryUsers},this.visibleCourses=null,this.notOwnedPaidCourses=null,me.courses&&(this.visibleCourses=me.courses.map((function(t){return t.titleId})),this.notOwnedPaidCourses=me.courses.filter((function(t){return"paid"==t.status&&!t.me.premium})).map((function(t){return t.titleId}))),this.init()}function codelive(t,e){this.$previewContainer=$("#"+t),this.$editContainer=$("#"+e),this.$previewContainer.hide(),this.$editContainer.hide(),this.$dataContainer="",this.emptyLC={title:"",code:{head:"",html:" ",css:" ",javascript:" "},alternativesLang:null,alternativesLangTitle:null,alternatives:{},zoomCode:1,lock:{enabled:"Social",code:"",from:0,to:0},notes:[],lastsave:""},this.lc=null,this.init()}function codetip(t,e){this.$previewContainer=$("#"+t),this.$editContainer=$("#"+e),this.$dataContainer="",this.textformatBar=new textFormat("tipformatbar"),this.init()}function textFormat(t){this.$wrapper=$("#"+t),this.$selectedimg="",this.$selectedcontainer="",this.init(),this.$elWait=null}posts.prototype={setContext:function(t,e,s){this.context.load=t,this.context.save=e,s||this.load("all")},getContext:function(t){return t&&this.context[t]?this.context[t]:this.context},queryUsers:function(t,e,s){var o=this,i=server+"users?searchU="+e;$.ajax({url:i,async:!0,type:"GET",dataType:"json",headers:{authuser:getUserToken()},success:function(t){if(t.success){var e=[];$.each(t.users,(function(t,s){e[t]={id:s.id,name:s.username,avatar:serverImg+"avatars/thumbs/"+s.id+".jpg",type:"contact"}})),s.call(o,e)}},error:function(){}})},init:function(){var t=this;this.options.enableNewPost?(this.relinkFormElements(),$.each(this.templateFormElements,(function(e,s){t.$emptyFormElements[e]=$(s).clone(!0),t.$emptyFormElements[e].attr("id",null)})),this.imageAddPrepare(),this.$els.postForm.find("textarea.data").mentionsInput(this.mentionsOptions)):this.postFormDisable(),$(".my-avatar").css("backgroundImage",'url("'+serverImg+"avatars/thumbs/"+me.id+'.jpg")'),this.options.enableNotifications?(this.postsNotification(),this.timers.newPost=window.setTimeout($.proxy(this.fetchNew,this),this.timeFetchNew)):this.postsNotificationsDisable(),this.$els.listPeopleHover.hide(),this.$els.noPostsFound.hide(),this.options.doNotLoadonInit||this.load("all",this.latestFilter),this.codetipobj=new codetip("codetippreview","codetipedit"),this.codelcobj=new codelive("codelcpreview","codelcedit")},fetchNew:function(){var t=this;$.each(this.allPostsData,(function(e,s){var o=t.$els.posts.find(t.groupClass.postItem+'[data-id="'+e+'"]');if(s.timeAgo=timeAgo(s.created,!0,!1),s.timeAgoM=timeAgo(s.modified,!0,!1),o.find(t.groupClass.postTimeAgo).text(s.timeAgo),s.timeAgo!=s.timeAgoM&&o.find(t.groupClass.postTimeAgoM).text("("+LWTranslate.get("common.updated")+" "+s.timeAgoM+")"),s.has_controls){var i=new Date,a=new Date(1e3*s.created);s.has_controls=i.getTime()-a.getTime()<t.timeForDelete,s.has_controls||o.find(t.groupClass.postControls).remove()}s.comments&&$.each(s.comments,(function(e,s){var i=o.find(t.groupClass.commentItem+"[data-id="+s.comment_id+"]");if(s.timeAgo=timeAgo(s.modified,!0,!1),i.find(t.groupClass.commentTimeAgo).text(s.timeAgo),s.has_controls){var a=new Date,n=new Date(1e3*s.created);s.has_controls=a.getTime()-n.getTime()<t.timeForDelete,s.has_controls||i.find(t.groupClass.commentControls).remove()}}))})),this.load("new")},setFirstKey:function(t,e){"undefined"!=typeof topBar&&!e&&topBar.context.length>0&&topBar.loadBarStatus(t),this.timers.newPost&&window.clearTimeout(this.timers.newPost),this.firstKey=t,this.options.enableNotifications&&(this.timers.newPost=window.setTimeout($.proxy(this.fetchNew,this),this.timeFetchNew))},load:function(t,e,s){if(t&&!this.loading){this.latestPost=null;var o=this;s||(s=12);var i=server+"posts?N="+s;if(e&&(this.latestFilter=e),"all"!=t||e&&"followed_by=me"!=e||(i+="&system"),"all"!=t||e||(this.latestFilter=null,this.latestKey=null,this.relinkFormElements()),"new"==t&&this.firstKey&&(i+="&first="+this.firstKey),"old"==t&&this.lastKey){if(this.lastKey==this.latestKey)return;this.latestKey=this.lastKey,i+="&last="+this.lastKey}this.context&&this.context.load&&(i+="&context="+this.context.load),this.latestFilter&&(i+="&"+this.latestFilter,this.relinkFormElements()),this.loading=!0,$.ajax({url:i,async:!0,type:"GET",dataType:"json",headers:{authuser:getUserToken()},success:function(e){if("new"==t&&o.options.enableNotifications&&(o.timers.newPost=window.setTimeout($.proxy(o.fetchNew,o),o.timeFetchNew)),e.success){"all"==t&&(o.allPostsData={},o.$els.posts.children().filter((function(){return $(this)[0]!==o.$els.noPostsFound[0]})).remove(),o.$els.noPostsFound.hide(),findKey(e.posts,"count")||"undefined"!=typeof authoringMode?findKey(e.posts,"count")||"undefined"==typeof authoringMode||$(".js-no-results").show():o.$els.noPostsFound.fadeIn(this.timeFade));var s=findKey(e.posts,"count"),i=findKey(e.posts,"last");for(s&&(o.$els.noPostsFound.hide(),"old"!=t&&(o.firstKey=null),"new"!=t&&(o.lastKey=null)),e.system&&(o.sysPostData=e.system,o.sysPostIndex=0),$.each(e.posts,(function(e,s){null==o.firstKey&&o.setFirstKey(s.modified,"all"==t),o.allPostsData[e]=s,o.postRender(e,t),"new"!=t&&(o.lastKey=s.modified,o.latestFilter&&"followed_by=me"!=o.latestFilter||o.systemMessageAdd()),e==i&&o.options.loadReadyCallback&&(window.setTimeout(3*o.timeFade,o.options.loadReadyCallback()),o.options.loadReadyCallbackOnce&&(o.options.loadReadyCallback=null))}));o.sysPostIndex<o.sysPostData.length;)o.systemMessageRender(),o.sysPostIndex++;"new"==t&&o.postsNotification(),"old"!=t&&(o.lastDateShort="")}else"/path-player"===window.location.pathname&&isUserImpersonationEnabled()||displayError(e.errors);o.loading=!1},error:function(){o.loading=!1,displayError()}})}},postDateShort:function(t){return dpStr=(t.getDate()>9?"":"0")+t.getDate()+"/"+(t.getMonth()>8?"":"0")+(t.getMonth()+1),dpStr!=this.lastDateShort?this.lastDateShort=dpStr:dpStr="",dpStr},postRender:function(t,e){var s,o,i=this;if(t?((s=this.allPostsData[t]).timeAgo=timeAgo(s.created,!0,!1),s.timeAgoM=timeAgo(s.modified,!0,!1),o=new Date(1e3*s.modified)):((s=this.latestPost.data).timeAgo=LWTranslate.get("common.just_now"),s.timeAgoM=LWTranslate.get("common.just_now"),o=new Date,this.lastDateShort=""),s.contextLink=null,s.context&&s.context.length>1){var a,n,l={"{ivideo}":"{"+LWTranslate.get("course.video")+"}","{ebook}":"{"+LWTranslate.get("course.ebook")+"}","{pbEbook}":"{"+LWTranslate.get("course.ebook")+"}","{pdf}":"{"+LWTranslate.get("course.pdf")+"}","{livecode}":"{"+LWTranslate.get("course.livecode")+"}","{assessment}":"{"+LWTranslate.get("course.assessment")+"}","{newSurvey}":"{"+LWTranslate.get("course.form")+"}","{assessmentV2}":"{"+LWTranslate.get("course.assessment")+"}","{certificate}":"{"+LWTranslate.get("course.certificate")+"}","{certificateCompletion}":"{"+LWTranslate.get("course.certificateCompletion")+"}","{certificate_v2}":"{"+LWTranslate.get("course.certificate")+"}","{certificateCompletion_v2}":"{"+LWTranslate.get("course.certificateCompletion")+"}","{snippet}":"{"+LWTranslate.get("course.snippet")+"}","{tip}":"{"+LWTranslate.get("course.tip")+"}","{html}":"{"+LWTranslate.get("course.html")+"}","{url}":"{"+LWTranslate.get("course.url")+"}","{youtube}":"{"+LWTranslate.get("course.youtube")+"}","{slideshare}":"{"+LWTranslate.get("course.slideshare")+"}","{soundcloud}":"{"+LWTranslate.get("course.soundcloud")+"}","{audio}":"{"+LWTranslate.get("course.audio")+"}","{embed}":"{"+LWTranslate.get("course.embed")+"}","{badge}":"{"+LWTranslate.get("course.badge")+"}","{quizBank}":"{"+LWTranslate.get("course.quizBank")+"}","{quizWritten}":"{"+LWTranslate.get("course.quizWritten")+"}","{quizFiles}":"{"+LWTranslate.get("course.quizFiles")+"}","{quizFormal}":"{"+LWTranslate.get("course.quizFormal")+"}","{quizInformal}":"{"+LWTranslate.get("course.quizInformal")+"}","{survey}":"{"+LWTranslate.get("course.survey")+"}","{scorm}":"{"+LWTranslate.get("course.scorm")+"}","{scormGraded}":"{"+LWTranslate.get("course.scormGraded")+"}","{colMooc}":"{"+LWTranslate.get("course.colMooc")+"}","{zoomMeeting}":"{"+LWTranslate.get("course.zoomMeeting")+"}","{zoomWebinar}":"{"+LWTranslate.get("course.zoomWebinar")+"}","{webexMeeting}":"{"+LWTranslate.get("course.webexMeeting")+"}","{goToWebinar}":"{"+LWTranslate.get("course.goToWebinar")+"}"},r=s.context[0];switch(Object.keys(l).forEach((function(t){r=r.replace(t,l[t])})),s.context.length){case 2:"dailyNews"==s.context[1]?(a="dialynews",n=null):"workpad"==s.context[1]?(a="workpad",n=null):(a="course",n={coursetitleid:s.context[1]});break;case 5:if(this.visibleCourses&&-1==this.visibleCourses.indexOf(s.context[1])){if(a="start",!me.isStaff)return;break}if(this.notOwnedPaidCourses&&this.notOwnedPaidCourses.indexOf(s.context[1])>-1){a="course",n={coursetitleid:s.context[1]};break}"path"==s.context[4]?(a="pathPlayer",n={coursetitleid:s.context[1],unit:s.context[3]}):(a="ebook",n={coursetitleid:s.context[1],chapter:s.context[2],page:s.context[3],el:s.context[4]});break;case 4:if(this.visibleCourses&&-1==this.visibleCourses.indexOf(s.context[1])){a="start";break}if(this.notOwnedPaidCourses&&this.notOwnedPaidCourses.indexOf(s.context[1])>-1){a="course",n={coursetitleid:s.context[1]};break}a="ivideo",n={coursetitleid:s.context[1],videoid:s.context[3]}}s.contextLink="v3"===window.getMobileClientVersion()?"javascript:void(0)":wwwelopersUrl(a,n),s.contextLink='<a href="'+s.contextLink+'" class="gray-link">@'+r+"</a>"}s.dateShort=this.postDateShort(o);var d=$(this.$els.postRenderer.render(s));return d.find(".my-avatar").css("backgroundImage",'url("'+serverImg+"avatars/thumbs/"+me.id+'.jpg")'),d.find(this.groupClass.commentShare).off("click").on("click",(function(t){var e=$(this).parent().find(".add-comment textarea");e.hide(),i.commentAdd(e)})),d.find(this.groupClass.commentsView).hide(),s.comments&&t&&($.each(s.comments,(function(e,s){i.commentRender(e,t,d)})),this.commentsNums(d,s),s.comments.length>this.options.commentsNumCollapse&&(d.find(this.groupClass.commentsView).text(LWTranslate.get("social.view_all")+" "+s.comments.length+" "+LWTranslate.get("social.comments")).show(),$.each(s.comments,(function(t,e){t<s.comments.length-i.options.commentsNumCollapse&&d.find(i.groupClass.commentItem+"[data-id="+e.comment_id+"]").addClass(i.selClass.commentMore).hide()})))),d.hide(),"old"==e||"all"==e?d.appendTo(this.$els.posts):this.$els.posts.find(this.groupClass.postDateShort+':contains("'+s.dateShort+'")').remove(),"new"===e&&(d.addClass(this.selClass.newPost).hide(),this.$els.posts.find("."+this.selClass.newPost).last().length?d.insertAfter(this.$els.posts.find("."+this.selClass.newPost).last()):d.prependTo(this.$els.posts)),"add"===e&&d.prependTo(this.$els.posts),d.hasClass(this.selClass.newPost.replace(".",""))||(d.fadeIn(2*this.timeFade,(function(){})),d.find("textarea").mentionsInput(this.mentionsOptions)),$.fancybox&&d.find(".image-flow-wrapper .img-name-wrapper, .image-flow-wrapper .image-name").fancybox({openEffect:"elastic",closeEffect:"elastic"}),this.options.afterPostRenderCallback&&this.options.afterPostRenderCallback(d),d},systemMessagesInject:function(){var t=this.sysPostIndex+Math.floor((this.sysPostData.length-this.sysPostIndex)/3)+1;for(t=t>this.sysPostData.length?this.sysPostData.length:t;this.sysPostIndex<t;){var e=this.$els.posts.find("."+this.groupClass.sysPost).last().index()+1,s=this.$els.posts.children().length-1,o=Math.floor(Math.random()*(s-e)+e),i=this.$els.posts.children().eq(o),a=this.sysPostData[this.sysPostIndex];$(this.$els["sysPostRenderer_"+a.post_type].render(a)).insertAfter(i),this.sysPostIndex++}},systemMessageAdd:function(){var t=!1;if(!(this.sysPostIndex>this.sysPostData.length-1)){var e=this.$els.posts.find("."+this.groupClass.sysPost).last().index()+1,s=this.$els.posts.children().length-1;s-e>3&&(t=1!=Math.floor(3*Math.random())),3!=s||this.sysPostIndex||(t=!0),t&&(this.systemMessageRender(),this.sysPostIndex++)}},systemMessageRender:function(){var t=this.sysPostData[this.sysPostIndex];"articles"==t.post_type&&(t.timeago=timeAgo(t.text.published));var e=$(this.$els["sysPostRenderer_"+t.post_type].render(t));e.appendTo(this.$els.posts),e.find(".badges-row").each((function(t,e){if($(e).children().length>3)for(var s=3;s<$(e).children().length;s++)$(e).children().eq(s).hide()}))},postAddReady:function(t){this.setFirstKey(t.modified),this.allPostsData[t.id]=this.latestPost.data,this.allPostsData[t.id].id=t.id,this.allPostsData[t.id].created=t.created,this.allPostsData[t.id].modified=t.modified,1==Object.keys(this.allPostsData).length&&(this.lastKey=t.modified),this.latestPost.$el.attr("data-id",t.id),this.latestPost=null},postsNotification:function(){var t=this.$els.postsMsg,e=this.$els.posts.find(this.groupClass.postItem+"."+this.selClass.newPost).length;e?(t.text(1==e?LWTranslate.get("social.new_post"):e+" "+LWTranslate.get("social.new_posts")),t.fadeIn(this.timeFade)):(t.text(LWTranslate.get("social.no_new_posts")),t.hide())},postsNotificationsDisable:function(){this.$els.postsMsg.hide()},postsDisplayNew:function(){var t=this.$els.posts.find(this.groupClass.postItem+"."+this.selClass.newPost),e=this;$.each(t,(function(t,s){var o=e.$els.posts.find(e.groupClass.postItem+'[data-id="'+$(s).attr("data-id")+'"]:not(.'+e.selClass.newPost+")");o.length&&o.remove(),$(s).removeClass(e.selClass.newPost).fadeIn(2*e.timeFade),$(s).find("textarea").mentionsInput(e.mentionsOptions),e.allPostsData[$(s).attr("data-id")].comments&&e.allPostsData[$(s).attr("data-id")].comments.length>e.options.commentsNumCollapse&&e.postDisplayCommentsMore($(s))})),this.$els.postsMsg.hide(),WI.rec("Displaying unread posts","posts-unread")},postInContext:function(t){return null!=this.latestPost?null:(t.hasClass(this.groupClass.postItem.replace(".",""))?$post=t:$post=t.parents(this.groupClass.postItem),$post.length?$post:null)},postAdd:function(t){if(null==this.latestPost){this.$els.noPostsFound.hide();var e=this,s=JSON.parse(JSON.stringify(this.newPost));if(this.$els.postForm.find("textarea.data").val().length){if(this.$els.postForm.css("border","0px solid"),this.latestFilter&&this.latestFilter.indexOf("context")>-1){var o=this.latestFilter.replace("context=",""),i=$("[data-lookup-title-id="+o+"]").length&&$("[data-lookup-title-id="+o+"]").find(".choice-name").length?$("[data-lookup-title-id="+o+"]").find(".choice-name").text():"";s.context=[i,o]}this.context&&this.context.save&&(s.context=this.context.save),"undefined"!=typeof pagesObj&&"undefined"==typeof authoringMode&&($extra=pagesObj.getContext(),s.context.push($extra.page),s.context.push($extra.el)),$(t.target).hasClass(this.selClass.team)&&(s.group_id=$(t.target).attr("data-id")),this.latestFilter&&this.latestFilter.indexOf("group_id")>-1&&(s.group_id=this.latestFilter.substring(this.latestFilter.indexOf("group_id")+9));var a=!1;if($.each(this.$els.postForm.find("."+this.selClass.data),(function(t,o){var i=$(o);if(i.attr("data-key")){if(i[0]===e.$els.addPoll[0])if(e.pollCollectData(i),e.$els.addPoll.data("data").options.length<2)return void(a=LWTranslate.get("social.poll_minimum_choices"));i.data("data")?i.hasClass("object_form")?(s.social_object.type=i.attr("data-key"),s.social_object.data=i.data("data"),i.data("data",null)):s[i.attr("data-key")]=i.data("data"):i.val().length&&(s[i.attr("data-key")]=i.val())}})),a)showMessage("alert",LWTranslate.get("social.oops"),a,[{name:"OK"}]);else{s=this.textMentions(this.$els.postForm.find("textarea.data"),s),this.loading=!0;var n=server+"posts";$.ajax({url:n,async:!0,type:"POST",dataType:"json",data:"data="+encodeURIComponent(JSON.stringify(s)),headers:{authuser:getUserToken()},success:function(t){t.success?(e.latestPost.$el.find(".post-text").html(t.post.text),e.latestPost.$el.show(),e.latestFilter&&!s.group_id&&-1==e.latestFilter.indexOf("context=")?$(".-all-activity").mousedown().click():s.group_id&&(!e.latestFilter||!e.latestFilter.indexOf(s.group_id)||e.latestFilter.indexOf(s.group_id)&&e.latestFilter.indexOf("social_object")>-1)?$('.team[data-id="'+s.group_id+'"] .group-activity').mousedown().click():s.context&&e.latestFilter&&-1!==e.latestFilter.indexOf("context=")&&e.latestFilter.replace("context=","")===s.context[1]?(e.loading=!1,$("[data-lookup-title-id="+s.context[1]+"]").trigger("mousedown").trigger("click")):e.postAddReady(t.post)):displayError(t.errors),e.loading=!1},error:function(){displayError(),e.loading=!1}}),this.postFormReset(),(!this.latestFilter||s.group_id&&e.latestFilter.indexOf(s.group_id))&&(s.text="",this.latestPost={$el:null,data:s},this.latestPost.data.user_id={id:me.id,username:me.username},this.latestPost.$el=this.postRender(null,"add"),this.latestPost.$el.hide()),WI.rec("Creating a new post","posts-new")}}else this.$els.postForm.find("textarea.data").attr("placeholder",LWTranslate.get("social.placeholder_no_share")).css("border","1px solid #d14e4f")}},textMentions:function(t,e){return t.mentionsInput("getMentions",(function(t){$.each(t,(function(t,s){e.text_mentions[t]={id:s.id,username:s.name},e.text=e.text.replace(s.name,'<a href="/profile?id='+s.id+'" class="blue-link">'+s.name+"</a>")}))})),e.text=e.text.replace(/\n/g,"<br />").linkify("blue-link","_blank"),e},postDelete:function(t){var e=this.postInContext(t);if(null!=e){var s=e.attr("data-id");showMessage("alert",LWTranslate.get("social.post_delete"),LWTranslate.get("social.post_delete_confirm")+':"'+e.find(".post-text").text().substring(0,30)+'..." '+LWTranslate.get("social.from")+" "+e.find(".name").text()+"?",[{name:LWTranslate.get("common.delete"),func:"socialNetwork.post_commentEditDelete",args:[s,null,"DELETE"]},{name:LWTranslate.get("common.cancel")}]),WI.rec("Deleting a post","posts-new")}},postEdit:function(t){var e=this.postInContext(t);if(null!=e){var s=e.attr("data-id"),o=e.find(this.groupClass.postText),i=o.find("textarea");if(i.length){var a=i.val(),n={text:null,text_mentions:null};n.text=a,n.text_mentions=a,this.post_commentEditDelete(s,null,"POST","data="+encodeURIComponent(JSON.stringify(n))),o.text(a),i.remove(),e.find(this.groupClass.postDelete).show()}else i=$(document.createElement("textarea")).val(o.text()).css("height","22px").css("width","100%"),e.find(this.groupClass.postDelete).hide(),o.text(""),i.appendTo(o),i.mentionsInput(this.mentionsOptions)}},postDisableEditDelete:function(t){},postAction:function(t,e){var s=this.postInContext(t);if(null!=s){var o=s.attr("data-id");if(this.allPostsData[o].user_id.id==me.id&&"best_of"==e)return showMessage("alert",LWTranslate.get("social.post_best_of"),LWTranslate.get("social.post_best_of_msg"),[{name:"OK"}]),!1;var i=s.find(this.groupClass["post_"+e]);$elNum=s.find(this.groupClass["post_"+e+"_num"]);var a,n=$elNum.text()?parseInt($elNum.text()):0;return i.hasClass(this.selClass[e])?(i.removeClass(this.selClass[e]),this.post_commentActionSave(o,null,"DELETE",e),n-=1,a="Adding"):(i.addClass(this.selClass[e]),this.post_commentActionSave(o,null,"POST",e),n+=1,a="Removing"),$elNum.text(n?n+"":""),WI.rec(a+" "+e+" from a post","posts-"+e),!1}},postActionDisplayUsers:function(t,e){var s=this.postInContext(t);if(null!=s){var o=s.attr("data-id"),i=s.find(this.groupClass["post_"+e+"_num"]);if(i.text()?parseInt(i.text()):0){var a=this.$els.listPeopleHover.find("div");a.html(null);var n=this;$.each(this.allPostsData[o][e],(function(t,e){$(document.createElement("div")).text(e.username).addClass(n.selClass.listPeopleNames).appendTo(a)}));var l=t.parents(".post-caption").position().top-this.$els.listPeopleHover.height()+(this.options.enableNewPost?this.$els.postForm.height():-10),r=t.position().left-12+t.parents(".post-caption").position().left;this.$els.listPeopleHover.css({left:r,top:l}).show()}}},postDisplayComments:function(t){var e=this.postInContext(t);null!=e&&e.find(this.groupClass.commentForm+" textarea").focus().scrollintoview1(this.$els.container)},postDisplayCommentsMore:function(t){var e=this.postInContext(t);if(null!=e){e.find("."+this.selClass.commentMore).removeClass(this.selClass.commentMore).show();e.find(this.groupClass.commentsView).addClass(this.selClass.commentsOpen)}},commentFormReset:function(t){t.find(this.groupClass.commentForm+" textarea").val("").mentionsInput("reset")},commentAdd:function(t){if(null===this.latestComment){var e=this,s=this.postInContext(t);if(null!=s){var o=s.attr("data-id"),i=JSON.parse(JSON.stringify(this.newComment));if(i.text=s.find(this.groupClass.commentForm+" textarea").val().trim(),!i.text.length)return s.find(this.groupClass.commentForm+" textarea").attr("placeholder",LWTranslate.get("social.placeholder_no_comment")),void t.show();t.css("height",""),i=this.textMentions(s.find(this.groupClass.commentForm+" textarea"),i);var a=server+"post/"+o+"/comment";$.ajax({url:a,async:!0,type:"POST",dataType:"json",data:"data="+encodeURIComponent(JSON.stringify(i)),headers:{authuser:getUserToken()},success:function(t){e.latestComment.$el.find(".comment-text").html(t.comment.text),e.latestComment.$el.show(),t.success?e.commentAddReady(t,o,s):displayError(t.errors),s.find(e.groupClass.commentForm+" textarea").show()},error:function(){displayError()}}),i.text="",this.latestComment={$el:null,data:i},this.latestComment.data.user_id={id:me.id,username:me.username},this.latestComment.$el=this.commentRender(null,o,s),this.latestComment.$el.hide(),this.commentFormReset(s),WI.rec("Commenting a post","posts-comment")}}else t.show()},commentAddReady:function(t,e,s){var o={};(o=this.latestComment.data).comment_id=t.comment.id,o.created=t.comment.created,o.modified=t.comment.created,this.allPostsData[e].comments&&this.allPostsData[e].comments.length||(this.allPostsData[e].comments=[]);var i=this.allPostsData[e].comments.length;this.allPostsData[e].comments[i]=o,this.allPostsData[e].modified=t.post.modified,this.setFirstKey(t.post.modified),this.commentsNums(s,this.allPostsData[e]),this.latestComment.$el.attr("data-id",t.comment.id),this.latestComment=null},commentRender:function(t,e,s){if(e){s||this.$els.posts.find(this.groupClass.postItem+"[data-id="+e+"]"),null==t?(data=this.latestComment.data,data.timeAgo=LWTranslate.get("common.just_now")):(data=this.allPostsData[e].comments[t],data.timeAgo=timeAgo(data.modified,!0));var o=$(this.$els.commentRenderer.render(data));return o.hide(),o.insertBefore(s.find(this.groupClass.commentForm)),o.fadeIn(this.timeFade),o}},commentsNums:function(t,e){var s=t.find(this.groupClass.commentsView),o=e.comments.length?e.comments.length:0;t.find(this.groupClass.post_comments_num).text(o),s.text(LWTranslate.get("social.view_all")+" "+o+" "+LWTranslate.get("social.comments"))},commentInContext:function(t){return null!=this.latestComment?null:($c=t.parents(this.groupClass.commentItem),$c.length?$c:null)},post_commentBestOfUndo:function(t,e){var s,o,i=this.$els.posts.find(this.groupClass.postItem+"[data-id="+t+"]");if(e){var a=i.find(this.groupClass.commentItem+"[data-id="+e+"]");s=a.find(this.groupClass.comment_best_of),o=a.find(this.groupClass.comment_best_of_num)}else s=i.find(this.groupClass.post_best_of),o=i.find(this.groupClass.post_best_of_num);var n=parseInt(o.text());n-=1,s.removeClass(this.selClass.best_of),o.text(n?n+"":"")},commentAction:function(t,e){var s=this.postInContext(t);if(null!=s){var o=this.commentInContext(t);if(null!=o){var i=s.attr("data-id"),a=o.attr("data-id"),n=this.commentFindIndex(i,a);if(null!=n){if(this.allPostsData[i].comments[n].user_id.id==me.id&&"best_of"==e)return showMessage("alert",LWTranslate.get("social.comment_best_of"),LWTranslate.get("social.comment_best_of_msg"),[{name:"OK"}]),!1;var l,r=o.find(this.groupClass["comment_"+e]),d=o.find(this.groupClass["comment_"+e+"_num"]),c=d.text().length?parseInt(d.text()):0;r.hasClass(this.selClass[e])?(r.removeClass(this.selClass[e]),this.post_commentActionSave(i,a,"DELETE",e),c-=1,l="Adding"):(r.addClass(this.selClass[e]),this.post_commentActionSave(i,a,"POST",e),c+=1,l="Removing"),d.text(c||""),WI.rec(l+" "+e+" from a post comment","posts-comment-"+e)}}}},commentDelete:function(t){var e=this.postInContext(t);if(null!=e){var s=e.attr("data-id"),o=this.commentInContext(t);if(null!=o){var i=o.attr("data-id");showMessage("alert",LWTranslate.get("social.comment_delete"),LWTranslate.get("social.comment_delete_confirm")+':"'+o.find(".comment-text").text().substring(0,30)+'..." '+LWTranslate.get("social.from")+" "+o.find(".comment-name").text()+"?",[{name:LWTranslate.get("common.delete"),func:"socialNetwork.post_commentEditDelete",args:[s,i,"DELETE"]},{name:LWTranslate.get("common.cancel")}]),WI.rec("Deleting a post comment","posts-comment-delete")}}},commentEdit:function(t){var e=this.postInContext(t);if(null!=e){var s=e.attr("data-id"),o=this.commentInContext(t);if(null!=o){var i=o.attr("data-id"),a=o.find(this.groupClass.commentText),n=a.find("textarea");if(n.length){var l=n.val(),r={text:null,text_mentions:null};r.text=l,r.text_mentions=l,this.post_commentEditDelete(s,i,"POST","data="+encodeURIComponent(JSON.stringify(r))),a.text(l),n.remove(),o.find(this.groupClass.commentDelete).show()}else n=$(document.createElement("textarea")).val(a.text()).css("height","22px").css("width","100%"),o.find(this.groupClass.commentDelete).hide(),a.text(""),n.appendTo(a),n.mentionsInput(this.mentionsOptions)}}},commentActionDisplayUsers:function(t,e){var s=this.postInContext(t);if(null!=s){var o=this.commentInContext(t);if(null!=o)if($elNum=o.find(this.groupClass["comment_"+e+"_num"]),$elNum.text().length?parseInt($elNum.text()):0){var i=s.attr("data-id"),a=o.attr("data-id"),n=this.commentFindIndex(i,a);if(null!=n){var l=this.$els.listPeopleHover.find("div");l.html(null);var r=this;$.each(this.allPostsData[i].comments[n][e],(function(t,e){$(document.createElement("div")).text(e.username).addClass(r.selClass.listPeopleNames).appendTo(l)}));var d=t.parents(".comment").eq(0).position().top-t.height()/2+t.parent().position().top-this.$els.listPeopleHover.height()+(this.options.enableNewPost?this.$els.postForm.height():-10),c=t.position().left-t.width()+2;this.$els.listPeopleHover.css({left:c,top:d}).show()}}}},commentFindIndex:function(t,e){var s=null;return $.each(this.allPostsData[t].comments,(function(t,o){o&&o.comment_id==e&&(s=t)})),s},post_commentActionSave:function(t,e,s,o){var i=this,a=server+"post/"+t+"/";e&&(a+="comment/"+e+"/"),a+=o,$.ajax({url:a,async:!0,type:s.toUpperCase(),dataType:"json",headers:{authuser:getUserToken()},success:function(a){if(a.success)if(e){var n=i.commentFindIndex(t,e);if(null==n)return;if("DELETE"==s.toUpperCase()){l=arrayFindIndexByKey(i.allPostsData[t].comments[n][o],"id",me.id);i.allPostsData[t].comments[n][o].splice(l,1)}if(findKey(i.allPostsData[t].comments[n][o],"count")||(i.allPostsData[t].comments[n][o]=[]),"POST"==s.toUpperCase()){r=i.allPostsData[t].comments[n][o].length;i.allPostsData[t].comments[n][o][r]={id:me.id,username:me.username},"best_of"==o&&i.setFirstKey(a.post.modified)}}else{if("DELETE"==s.toUpperCase()){var l=arrayFindIndexByKey(i.allPostsData[t][o],"id",me.id);i.allPostsData[t][o].splice(l,1)}if(findKey(i.allPostsData[t][o],"count")||(i.allPostsData[t][o]=[]),"POST"==s.toUpperCase()){var r=i.allPostsData[t][o].length;i.allPostsData[t][o][r]={id:me.id,username:me.username},"best_of"==o&&i.setFirstKey(a.post.modified)}}else displayError(a.errors),"best_of"==o&&i.post_commentBestOfUndo(t,e)},error:function(){}})},post_commentEditDelete:function(t,e,s,o){var i=this;if(hasCommunityManagePermission()&&void 0!==me.meli&&me.meli%2==0)var a=server+"author/post/"+t;else a=server+"post/"+t;e&&(a+="/comment/"+e),$.ajax({url:a,async:"POST"==s.toUpperCase(),type:s.toUpperCase(),data:o,dataType:"json",headers:{authuser:getUserToken()},success:function(o){var a,n,l=i.$els.posts.find(i.groupClass.postItem+"[data-id="+t+"]");if($("#postButtons").hide().appendTo($("body")),$("#commentButtons").hide().appendTo($("body")),e){if(null==(a=i.commentFindIndex(t,e)))return;n=l.find(i.groupClass.commentItem+"[data-id="+e+"]")}o.success?(e||"DELETE"!=s.toUpperCase()||(delete i.allPostsData[t],l.fadeOut(i.timeFade,(function(){$("#postButtons").hide().appendTo($("body")),l.remove(),1==i.$els.posts.children().length&&"undefined"==typeof authoringMode?i.$els.noPostsFound.show():1==i.$els.posts.children().length&&"undefined"!=typeof authoringMode&&$(".js-no-results").show()}))),e&&"DELETE"==s.toUpperCase()&&(i.allPostsData[t].comments.splice(a,1),n.fadeOut(i.timeFade,(function(){n.remove()})),i.commentsNums(l,i.allPostsData[t]),i.setFirstKey(o.post.modified)),"POST"==s.toUpperCase()&&(i.allPostsData[t].modified=o.post.modified,i.firstKey=o.post.modified,i.setFirstKey(o.post.modified))):(displayError(o.errors),e?(n.find(i.groupClass.commentControls).hide(),"POST"==s.toUpperCase()&&n.find(i.groupClass.commentText).text(i.allPostsData[t].comments[a].text)):(l.find(i.groupClass.postControls).hide(),"POST"==s.toUpperCase()&&l.find(i.groupClass.postText).text(i.allPostsData[t].text)))},error:function(){}})},pollVote:function(t){var e=this.postInContext(t);if(null!=e){var s=t.find("input").attr("id");if(s){var o=e.attr("data-id"),i=this,a=server+"post/"+o+"/vote/"+s;e.find(this.groupClass.pollVote).hide(),e.find(i.groupClass.pollWaiting).show(),$.ajax({url:a,async:!0,type:"POST",dataType:"json",headers:{authuser:getUserToken()},success:function(t){t.success?(i.allPostsData[o].social_object.data=t.poll.data,i.allPostsData[o].social_object.data.me=!0,i.pollResults(e,o)):displayError(t.errors)},error:function(){}}),WI.rec("Ansewering a poll","poll-vote")}}},pollResults:function(t,e){t.find(this.groupClass.pollWaiting).remove();var s=$(this.$els.postRenderer.render(this.allPostsData[e]));s.find(this.groupClass.pollFlow).hide().insertAfter(t.find(this.groupClass.pollVote)).fadeIn(this.timeFade);t.find(this.groupClass.pollVote).remove(),s.remove()},relinkFormElements:function(){if(this.options.enableNewPost){var t=this;$.each(this.templateFormElements,(function(e,s){t.$els[e]=$(s)})),$.each(this.formPointers,(function(e,s){t.$formCollections[e]=$(s)})),this.$formCollections.postFormTabs.parent().createselectablemenu2("share-choice-wrapper","-na","share-choice-wrapper-active"),LWSettings.components_settings.posts.tips||$("#shareTip").hide(),LWSettings.components_settings.posts.livecode||$("#shareCode").hide(),this.$els.addLink.find("input").on("keydown",(function(e){13===(e.keyCode?e.keyCode:e.which)&&t.linkAdd()})),this.$els.postAddButton.off("click").on("click",(function(e){cancelBubbling(e),t.postAdd(e)})),!this.context.load&&me&&me.groups&&(this.$els.postAddButton.find("ul li."+this.selClass.team).remove(),$.each(me.groups,(function(e,s){$(document.createElement("li")).addClass(t.selClass.team).appendTo(t.$els.postAddButton.find("ul")).attr("data-id",s.id).text(s.name)})),this.$els.postAddButton.find("li").length<2||this.latestFilter&&this.latestFilter.indexOf("group_id")>-1?this.$els.postAddButton.find("div").hide():this.$els.postAddButton.find("div").show()),this.context.load&&this.$els.postAddButton.find("div").hide(),this.$els.postForm.show()}},postFormDisable:function(){this.$els.postForm.hide()},postFormReset:function(){var t=this.$emptyFormElements.postForm.clone(!0),e=this.$els.postForm.attr("id");t.insertAfter(this.$els.postForm),this.$els.postForm.remove(),t.attr("id",e),this.relinkFormElements(),this.imageAddPrepare(),this.$els.postForm.find("textarea.data").mentionsInput(this.mentionsOptions),$(".my-avatar").css("backgroundImage",'url("'+serverImg+"avatars/thumbs/"+me.id+'.jpg")')},postFormTabShow:function(t){this.$formCollections.postFormObjects.hide().removeClass(this.selClass.data),this.$els[t].show().addClass(this.selClass.data),WI.rec("Selecting post form tab: "+t,"posts-form-tab")},postFormTabReset:function(t){this.$els.wait.hide();var e=this.$emptyFormElements[t].clone(!0).insertAfter(this.$els[t]),s=this.$els[t].attr("id");this.$els[t].remove(),this.$els[t]=e,this.$els[t].attr("id",s),$(socialNetwork.formPointers.postFormTabs).removeClass("share-choice-wrapper-active"),this.relinkFormElements(),"addImage"==t&&this.imageAddPrepare()},imageAddPrepare:function(){var t=this;$(this.templateFormElements.addImage+"_btn").fileupload({pasteZone:null,dataType:"json",url:api+"file/social?client_id="+lw_client,singleFileUploads:!0,sequentialUploads:!0,type:"POST",dropZone:this.$els.addImage,start:function(e,s){t.$els.wait.show()},stop:function(e,s){t.$els.wait.hide()},done:function(e,s){s.result.success?t.imageReady(s.result.fileInfo):displayError(s.result.errors)},fail:function(t,e){displayError(e.errorThrown)},progress:function(e,s){var o=parseInt(s.loaded/s.total*100,10);t.$els.wait.find("span").text(LWTranslate.get("common.waiting")+o+"%")}})},imageReady:function(t){this.$els.addImage.data("data",t.name);var e=fileServer+"imagefile"+(t.name.indexOf(t.name,"/")<0?"/":"")+t.name+"?client_id="+lw_client+"&folder=social&width=50&height=50";this.$els.addImage.find(".soc-image").css("background-image","url("+e+")")},linkAdd:function(){var t=this,e=this.$els.addLink.find("input").val();$.ajax({url:server+"url/info?url="+e,type:"GET",dataType:"json",headers:{authuser:getUserToken()},async:!0,success:function(e,s,o){e.success?t.linkReady(e.urlInfo):(displayError(e.errors),t.linkWait())},error:function(e,s,o){displayError(),t.linkWait()}}),this.linkWait(!0)},linkWait:function(t){t?(this.$els.addLink.find(".-attach").hide(),this.$els.wait.show()):(this.$els.wait.hide(),!1!==t&&this.$els.addLink.find(".-attach").show())},linkReady:function(t){this.linkWait(!1),this.$els.addLink.data("data",t),this.$els.addLink.find("#linkWrapper").show(),t.image&&this.$els.addLink.find(".link-image").css("background-image","url("+t.image.url+")"),this.$els.addLink.find(".link-title").text(t.title),this.$els.addLink.find(".link-desc").text(t.description),this.$els.addLink.find(".link").text(t.url)},pollAddChoice:function(){if(!(this.$formCollections.postFormPollChoices.length+1>8)){this.$formCollections.postFormPollChoices.length+1==8&&this.$els.postFormPollAddChoice.hide();var t=this.$formCollections.postFormPollChoices.eq(0).clone(!0).appendTo(this.$formCollections.postFormPollChoices.eq(0).parent());t.find('input[type="text"]').val("").attr("placeholder",LWTranslate.get("social.placeholder_poll_new_choice"));var e=parseInt(this.$els.addPoll.attr("data-lastnum"))+1;this.$els.addPoll.attr("data-lastnum",e),e="ch_"+e,t.find('input[type="radio"]').attr("id",e),t.find("label").attr("for",e),this.$formCollections.postFormPollChoices=$(this.formPointers.postFormPollChoices)}},pollDeleteChoice:function(t){this.$formCollections.postFormPollChoices.length>1&&(t.parents(".poll-choice").remove(),this.$formCollections.postFormPollChoices=$(this.formPointers.postFormPollChoices),this.$formCollections.postFormPollChoices.length<8&&this.$els.postFormPollAddChoice.show())},pollCollectData:function(){var t,e=this.$els.addPoll.find(this.groupClass.pollOption);(t={text:"",type:"poll"}).totalVotes=0,t.options=[];for(var s=0,o=0;o<e.length;o++){var i=e.eq(o).find('input[type="text"]').val().trim(),a=e.eq(o).find('input[type="radio"]').attr("id");""!==i&&(s=t.options.length,t.options[s]={},t.options[s].text=i,t.options[s].id=a,t.options[s].results={val:0,per:0})}this.$els.addPoll.data("data",t)},lcAdd:function(){this.codelcobj.showEdit($("#addCode .soc-image"))},lcReady:function(){},lcRemove:function(){},tipAdd:function(){this.codetipobj.showEdit($("#addTip .soc-image"))},tipReady:function(){},tipRemove:function(){}},codelive.prototype={init:function(){var t=this;this.$editContainer.find(".win-close, .cancel_button").on("click",(function(e){t.$editContainer.hide()})),this.$editContainer.find(".save_button").on("click",(function(e){t.saveLC()})),this.$previewContainer.find(".win-close").on("click",(function(e){t.$previewContainer.hide()}))},showEdit:function(t){if(this.$editContainer.is(":visible"))this.$editContainer.hide();else{this.$dataContainer=$("#addCode");var e=this.$dataContainer.data("data")?this.$dataContainer.data("data"):JSON.parse(JSON.stringify(this.emptyLC));this.calculateShowPosition(t,"edit"),autoclose(this.$editContainer,"hide",!0),this.initLC(this.$editContainer,e),WI.rec("Editing CodeLive in a new post","posts-form-lc-edit")}},showPreview:function(t){0==t.parents(".snWrapper2").length&&$(document).trigger("mousedown");var e=t.parents(".post-wrapper").attr("data-id");if(this.$previewContainer.is(":visible")&&this.$previewContainer.attr("temppostid")==e)this.$previewContainer.hide();else{this.$previewContainer.attr("temppostid",e);var s=socialNetwork.allPostsData[e].social_object.data;this.calculateShowPosition(t,"preview"),autoclose(this.$previewContainer,"hide",!0),this.initLC(this.$previewContainer,s),WI.rec("Viewing Codelive attached to post","posts-form-lc-view")}},calculateShowPosition:function(t,e){var s="edit"===e?this.$editContainer:this.$previewContainer,o=posInWindow({top:t.offset().top-30,left:t.offset().left+t.width()},s,!1,t);s.css(o).show()},initLC:function(t,e){this.lc=null,this.lc=new livecode(t.show().find(".lccontent"),e);var s=this;t.find(".lc-tabs").createselectablemenu("","active"),t.find("#lcTabRun").off("click").on("click",(function(){s.lc.run()})),t.find("#lcTabHtml").off("click").on("click",(function(){s.lc.showCode("html"),s.lc.editors.html.focus()})),t.find("#lcTabCss").off("click").on("click",(function(){s.lc.showCode("css"),s.lc.editors.css.focus()})),t.find("#lcTabJS").off("click").on("click",(function(){s.lc.showCode("javascript"),s.lc.editors.javascript.focus()})),t.find(".lc-full-screen").off("click").on("click",(function(t){s.lc.maximize(),cancelBubbling(t)})),t.find("#lcTabRun").mousedown()},saveLC:function(){this.$dataContainer=$("#addCode");var t=this.lc.source;$.each(this.lc.editors,(function(e,s){t.code[e]=s.getValue()})),this.$dataContainer.data("data",t),this.$editContainer.hide()}},codetip.prototype={init:function(){var t=this;this.$editContainer.find(".win-close, .cancel_button").on("click",(function(e){t.$editContainer.hide()})),this.$previewContainer.find(".win-close").on("click",(function(e){t.$previewContainer.hide()})),this.$editContainer.find(".save_button").on("click",(function(e){t.saveTip()}))},showEdit:function(t){if(this.$editContainer.is(":visible"))this.$editContainer.hide();else{this.$dataContainer=$("#addTip");var e=this.$dataContainer.data("data")?this.$dataContainer.data("data"):"";this.calculateShowPosition(t,"edit"),this.$editContainer.show().find(".tipcontent").html(e).focus(),autoclose(this.$editContainer,"hide",!0),WI.rec("Editing Tip in a new post","posts-form-tip-edit")}},showPreview:function(t){0==t.parents(".snWrapper2").length&&$(document).trigger("mousedown");var e=t.parents(".post-wrapper").attr("data-id");if(this.$previewContainer.is(":visible")&&this.$previewContainer.attr("temppostid")==e)this.$previewContainer.hide();else{this.$previewContainer.attr("temppostid",e);var s=socialNetwork.allPostsData[e].social_object.data;this.calculateShowPosition(t,"preview"),this.$previewContainer.show().find(".codingtipcontent").html(s),autoclose(this.$previewContainer,"hide",!0),WI.rec("Viewing Tip attached ina a post","posts-form-tip-view")}},calculateShowPosition:function(t,e){var s="edit"==e?this.$editContainer:this.$previewContainer,o=posInWindow({top:t.offset().top-30,left:t.offset().left+t.width()},s,!1,t);s.css(o).show()},saveTip:function(){this.$dataContainer=$("#addTip"),this.$dataContainer.data("data",this.$editContainer.find(".tipcontent").html()),this.$editContainer.hide()}},textFormat.prototype={init:function(){var t=this;this.$wrapper.find(".toolbarbutton, .box").each((function(t){var e=$(this).attr("data-cmd");!e||document.queryCommandSupported(e)||$(this).attr("data-applier")||"true"==$(this).attr("data-custom")||$(this).hide()})).on("click",(function(e){t.apply($(this)),e.stopPropagation()})).on("mousedown",(function(t){t.preventDefault()}))},apply:function(t){var e=t.attr("data-cmd"),s=null;if(t.attr("data-value")&&(s=t.attr("data-value")),"promptUser"==t.attr("data-type")&&(s=window.prompt(t.attr("data-prompt"),t.attr("data-title"))),e)if("rangy"==t.attr("data-applier"))this.applyWithRangy(t,e,s);else{var o=getSelectionParentElement();try{document.execCommand(e,!1,s)}catch(t){console.log(t)}switch(e){case"insertimage":var i=$(o).find("[src='"+s+"']");document.execCommand("enableObjectResizing",!1,!1),i.attr("contentEditable","false");break;case"createlink":$(o).find("[href='"+s+"']").attr("target","_new")}}if(t.attr("data-custom"))switch(t.attr("data-custom")){case"insertimage":this.insertImageInit_general();break;case"insertcode_html":this.insertCode(!1,"markup");break;case"insertcode_css":this.insertCode(!1,"css");break;case"insertcode_js":this.insertCode(!1,"javascript")}},applyWithRangy:function(t,e,s){cssApplier=rangy.createCssClassApplier("tempclass",{normalize:!0}),cssApplier.applyToSelection();var o,i=$(".tempclass");switch(e){case"insertcss":2==(o=s.split(":")).length&&i.css(o[0],o[1]);break;case"insertclass":i.addClass(t.attr("data-value"))}i.removeClass("tempclass")},insertImageInit_general:function(){var t=this;this.$selectedcontainer=$(getSelectionParentElement());var e=this.$selectedcontainer.parent("#codetipedit").find(".-toolbar-image-btn");if(this.$elWait||(this.$elWait=$(document.createElement("div")).prependTo(this.$wrapper).addClass("lcWait").css({background:"transparent"}).html($("#waitingWrapper").html()).addClass("waiting")),e.fileupload({dropZone:null,dataType:"json",url:api+"file/social",singleFileUploads:!0,sequentialUploads:!0,type:"POST",start:function(e,s){t.$elWait.show()},stop:function(e,s){t.$elWait.hide()},done:function(e,s){s.result.success?t.insertImage(s.result.fileInfo):displayError(s.result.errors)},fail:function(t,e){displayError(e.errorThrown)},progress:function(t,e){}}),this.$selectedcontainer.hasClass("htmledit")||this.$selectedcontainer.parents(".htmledit").length>0){var s="<img class='tempimage' src='"+imagePath+"/images/tempimg.png'/>";insertHtmlAtCursor(s)&&e.click()}},insertImage:function(t){var e=serverImg+"social/"+t.name;$newimage=this.$selectedcontainer.find(".tempimage"),$newimage.attr("src",e),$newimage.removeClass("tempimage")},insertCode:function(t,e){var s=this;if(e&&(this.$selectedcontainer=$(getSelectionParentElement())),e&&(this.$selectedcontainer.hasClass("htmledit")||this.$selectedcontainer.parents(".htmledit").length>0)){var o="<textarea id='"+(i=createTimeID())+"' class='codeedit noedit' placeholder='Insert Code' style='border:1px solid black'></textarea><br/><br/><br/>";if(insertHtmlAtCursor(o)){if($newcode=$("#"+i),$newcode.attr("data-lang",e),$newcode.parents(".noedit").length>0)return void $newcode.remove();$newcode.tabby(),$newcode.on("mouseover",(function(t){0===$("#"+i+"button").length&&s.createEditButton(i,"HTMLFormat","Format")})),$newcode.elastic(),$newcode.focus()}}else if(t){var i=t.attr("id"),a=t,n=t.text(),l=(o="<textarea id='"+i+"' class='codeedit noedit' placeholder='Insert Code' ></textarea><br/><br/><br/>",$(o).insertAfter(a));l.tabby(),l.elastic(),a.remove(),l.attr("id",i).val(n),$("#"+i+"button").remove(),$("#"+i+"buttonclose").remove(),l.on("mouseover",(function(t){s.createEditButton(i,"HTMLFormat","Format")}))}},HTMLFormat:function(t){var e=this;lang=t.attr("data-lang"),lang=lang||"markup";var s=t.val();s=$("<div/>").text(s).html();var o=t.attr("id"),i=$('<div><pre><code class="language-'+lang+'">'+s+"</code></pre></div>");i.css({width:t.width()+"px",height:t.height()+"px"}).addClass("noedit").attr("contenteditable",!1).insertAfter(t),t.remove(),i.attr("id",t.attr("id")),$("#"+o+"button").remove(),$("#"+o+"buttonclose").remove(),i.on("mouseover",(function(t){e.createEditButton(o,"insertCode","Edit")})),Prism.highlightAll()},createEditButton:function(t,e,s){var o=this,i=$("#"+t),a=e,n=0;0==$("#"+t+"button").length&&($("#createTeamForm").length>0&&(n=30),$(document.createElement("div")).attr("id",t+"button").addClass("formatcodebutton").addClass("button").text(s).css({top:i.offset().top+5-n,left:i.offset().left+i.width()-60,"z-index":"13000"}).appendTo("body").on("click",(function(t){o[a](i,!1)})).on("mousedown",(function(t){cancelBubbling(t)})),$(document.createElement("div")).attr("id",t+"buttonclose").addClass("formatcodebutton").addClass("button").text("Delete").css({top:i.offset().top+30-n,left:i.offset().left+i.width()-60}).appendTo("body").on("click",(function(e){$("#"+t).remove(),$("#"+t+"button").remove(),$("#"+t+"buttonclose").remove()})).on("mousedown",(function(t){cancelBubbling(t)})),i.on("mouseout",(function(e){(e.pageY<i.offset().top||e.pageY>i.offset().top+i.height()||e.pageX<i.offset().left||e.pageX>i.offset().left+i.width())&&($("#"+t+"button").remove(),$("#"+t+"buttonclose").remove())})))}};var usersData={};function userInfoOpen(t,e){var s;if(s=e.attr("data-id")?e:e.parents("[data-id]"),t==me.id&&(usersData[t]=me),usersData[t]){$("#profile").html($("#userInfoTemplate").render(usersData[t])),void 0!==window.SITE_DISABLE_INBOX&&"disabled"===window.SITE_DISABLE_INBOX&&me&&void 0!==me.isStaff&&"staff"!==me.isStaff?$("#profile").find(".js-send-msg-btn").length&&$("#profile").find(".js-send-msg-btn").hide():void 0!==window.SITE_DISABLE_INBOX&&window.SITE_DISABLE_INBOX&&me&&void 0!==me.isStaff&&"staff"!==me.isStaff&&void 0!==usersData[t].isStaff&&"staff"!==usersData[t].isStaff&&$("#profile").find(".js-send-msg-btn").length&&$("#profile").find(".js-send-msg-btn").hide(),$("#profile").attr("data-id",t);var o=s.offset().top,i=s.offset().left+25;$("#profile").show().css({left:i,top:o}).attr("data-id",t).disableSelection(),t==me.id&&$("#profile").find(".-member-prof-but").hide(),"v3"===window.getMobileClientVersion()&&"/path-player"===window.location.pathname&&($("#profile").find($(".send-msg")).hide(),$("#profile").find($(".js-go-to-profile-but")).hide()),autoclose($("#profile"),"hide",!0),WI.rec("Opening small profile card for user: "+usersData[t].username+"' clicking "+(e.html().indexOf("img")>-1?"avatar":"username"),"profileinfo-win")}else if(t){var a=server+"user/"+t;$.ajax({url:a,async:!0,type:"GET",dataType:"json",headers:{authuser:getUserToken()},success:function(s){s.success?(usersData[t]=s.user,userInfoOpen(t,e)):displayError(s.errors)},error:function(){displayError("NO DATA")}})}}function listPeopleSearch(){var t=$("#membersContainer").attr("data-filter");if(WI.rec("Searching for '"+e+"' in users ["+t+"]","userswin-search"),t){var e=$("#memberSearch").val().trim();listPeople(t+="&search="+e,!0)}}function listPeopleOpen(t){var e,s,o=me;if(t.parents("#friends").length&&(o=profile),t.parents("#profile").length&&($card=t.parents("#profile").eq(0),o={id:$card.attr("data-id"),following_count:$card.find(".-following .-following-value").text(),followers_count:$card.find(".-followers .-following-value").text()}),t.hasClass("-following")||t.parents("#following").length){if(!o.following_count)return void showMessage("alert",LWTranslate.get("social.following"),LWTranslate.get("social.following_no"),[{name:"OK"}]);e="following="+o.id,s=LWTranslate.get("social.following")}if(t.hasClass("-followers")||t.parents("#followers").length){if(!o.followers_count)return void showMessage("alert",LWTranslate.get("social.followers"),LWTranslate.get("social.followers_no"),[{name:"OK"}]);e="followers="+o.id,s=LWTranslate.get("social.followers")}(t.parents("#allUsers").length&&(e="allUsers=true",s=LWTranslate.get("social.all")),t.hasClass("group-members"))&&(e="group_id="+(i=t.parents(".team").eq(0).attr("data-id")),e+="&mode="+(me.groups[i].me_owner?"owner":"group"),s=t.parents(".team").eq(0).find(".team-name").text(),s+=" "+LWTranslate.get("social.members").toLowerCase());if(t.hasClass("group-invite")){var i=t.parents(".team").eq(0).attr("data-id");if(!me.groups[i].me_owner)return;e="group_id="+i,e+="&mode=invite",s=LWTranslate.get("social.invite_to")+" ",s+=t.parents(".team").eq(0).find(".team-name").text()}e&&($("#listPeople").html($("#listPeopleWrapTemplate").html()),$("#listPeople").find(".-win-title").text(s),$("#memberSearch").on("keydown",(function(t){13===(t.keyCode?t.keyCode:t.which)&&listPeopleSearch()})),showModalDialog("listPeople"),listPeople(e),WI.rec("Opening '"+s+"' users win","userswin-open"))}function listPeople(t,e,s){var o=server+"users?"+t;$.ajax({url:o,async:!0,type:"GET",dataType:"json",headers:{authuser:getUserToken()},success:function(s){s.success?(e||$("#membersContainer").attr("data-filter",t),$.each(s.users,(function(t,e){(void 0!==window.SITE_DISABLE_INBOX&&"disabled"===window.SITE_DISABLE_INBOX&&me&&void 0!==me.isStaff&&"staff"!==me.isStaff||void 0!==window.SITE_DISABLE_INBOX&&window.SITE_DISABLE_INBOX&&me&&void 0!==me.isStaff&&"staff"!==me.isStaff&&void 0!==e.isStaff&&"staff"!==e.isStaff)&&(e.disableMessaging=!0)})),$("#membersContainer").html($("#listPeopleItemTemplate").render(s.users))):displayError(s.errors)},error:function(){displayError("NO DATA")}})}function userListAction(t){WI.rec("Clicking button '"+t.text().trim()+"' in users window","userswin-action");var e=t.parents(".member-card").length?t.parents(".member-card").eq(0):null;if(e||(e=t.parents("#profile").length?t.parents("#profile").eq(0):null),e||(e=t.parents("#watchProf").length?t.parents("#watchProf").eq(0):null),e||(e=t.parents(".profile-card").length?t.parents(".profile-card").eq(0):null),e){var s=e.attr("data-id");if(s){var o,i=t.attr("data-mode"),a=server;switch(i){case"invite":a+="group/"+$("#membersContainer").attr("data-filter").replace("&mode=invite","").replace("group_id=","")+"/invite/"+s,o="POST",t.text(LWTranslate.get("common.invited")),t.removeClass("member-blue-but"),t.addClass("-disable-inv"),t.attr("onclick",null),t.off("click");break;case"owner":a+="group/"+$("#membersContainer").attr("data-filter").replace("&mode=owner","").replace("group_id=","")+"/members/"+s,o="DELETE",e.remove();break;default:a+="user/follow/"+s,o=t.attr("data-action").indexOf(LWTranslate.get("unfollow"))>-1?"DELETE":"POST",t.text("POST"==o?LWTranslate.get("common.unfollow"):LWTranslate.get("common.follow")),t.attr("data-action","POST"===o?"unfollow":"follow"),"undefined"!=typeof followChanged&&followChanged("POST"==o?"add":"remove",s)}$.ajax({url:a,async:!0,type:o,dataType:"json",headers:{authuser:getUserToken()},success:function(t){t.success||displayError(t.errors)},error:function(){displayError()}})}}}function userSpammy(t){var e=t.parents(".member-card").length?t.parents(".member-card").eq(0):null;if(e||(e=t.parents("#profile").length?t.parents("#profile").eq(0):null),e||(e=t.parents("#watchProf").length?t.parents("#watchProf").eq(0):null),e){var s=e.attr("data-id");s&&showMessage("alert",LWTranslate.get("social.spammy_alert_title"),LWTranslate.get("social.spammy_alert_content"),[{name:LWTranslate.get("common.ok"),func:"sendUserSpammy",args:s},{name:LWTranslate.get("common.cancel")}])}}function sendUserSpammy(t){var e=server;e+="user/abuse/"+t,$.ajax({url:e,async:!0,type:"POST",dataType:"json",headers:{authuser:getUserToken()},success:function(t){t.success||displayError(t.errors)},error:function(){displayError()}}),WI.rec("Reporting spammy user: "+t,"user-spammy")}